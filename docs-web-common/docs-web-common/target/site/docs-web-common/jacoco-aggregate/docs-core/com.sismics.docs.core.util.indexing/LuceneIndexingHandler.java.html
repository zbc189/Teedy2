<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LuceneIndexingHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Docs Web Commons</a> &gt; <a href="../index.html" class="el_bundle">docs-core</a> &gt; <a href="index.source.html" class="el_package">com.sismics.docs.core.util.indexing</a> &gt; <span class="el_source">LuceneIndexingHandler.java</span></div><h1>LuceneIndexingHandler.java</h1><pre class="source lang-java linenums">package com.sismics.docs.core.util.indexing;

import com.google.common.base.Joiner;
import com.google.common.base.Strings;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.sismics.docs.core.constant.ConfigType;
import com.sismics.docs.core.constant.PermType;
import com.sismics.docs.core.dao.ConfigDao;
import com.sismics.docs.core.dao.criteria.DocumentCriteria;
import com.sismics.docs.core.dao.dto.DocumentDto;
import com.sismics.docs.core.event.RebuildIndexAsyncEvent;
import com.sismics.docs.core.model.context.AppContext;
import com.sismics.docs.core.model.jpa.Config;
import com.sismics.docs.core.model.jpa.Document;
import com.sismics.docs.core.model.jpa.File;
import com.sismics.docs.core.util.DirectoryUtil;
import com.sismics.docs.core.util.SecurityUtil;
import com.sismics.docs.core.util.jpa.PaginatedList;
import com.sismics.docs.core.util.jpa.PaginatedLists;
import com.sismics.docs.core.util.jpa.QueryParam;
import com.sismics.docs.core.util.jpa.SortCriteria;
import com.sismics.util.ClasspathScanner;
import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.analysis.standard.StandardAnalyzer;
import org.apache.lucene.document.Field;
import org.apache.lucene.document.StringField;
import org.apache.lucene.document.TextField;
import org.apache.lucene.index.CheckIndex;
import org.apache.lucene.index.ConcurrentMergeScheduler;
import org.apache.lucene.index.DirectoryReader;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.index.IndexWriterConfig;
import org.apache.lucene.index.Term;
import org.apache.lucene.queryparser.simple.SimpleQueryParser;
import org.apache.lucene.search.BooleanClause;
import org.apache.lucene.search.BooleanQuery;
import org.apache.lucene.search.IndexSearcher;
import org.apache.lucene.search.ScoreDoc;
import org.apache.lucene.search.TopDocs;
import org.apache.lucene.search.highlight.Highlighter;
import org.apache.lucene.search.highlight.QueryScorer;
import org.apache.lucene.search.highlight.SimpleHTMLEncoder;
import org.apache.lucene.search.highlight.SimpleHTMLFormatter;
import org.apache.lucene.search.spell.LuceneDictionary;
import org.apache.lucene.search.suggest.Lookup;
import org.apache.lucene.search.suggest.analyzing.FuzzySuggester;
import org.apache.lucene.store.Directory;
import org.apache.lucene.store.NIOFSDirectory;
import org.apache.lucene.store.NoLockFactory;
import org.apache.lucene.store.RAMDirectory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

/**
 * Lucene indexing handler.
 * Documents and files are indexed in Lucene, but only used for fulltext search.
 * Other search criteria are still using the database.
 *
 * @author bgamard
 */
@ClasspathScanner.Priority(100)
<span class="fc" id="L74">public class LuceneIndexingHandler implements IndexingHandler {</span>
    /**
     * Logger.
     */
<span class="fc" id="L78">    private static final Logger log = LoggerFactory.getLogger(LuceneIndexingHandler.class);</span>

    /**
     * Lucene directory.
     */
    private Directory directory;

    /**
     * Directory reader.
     */
    private DirectoryReader directoryReader;

    /**
     * Index writer.
     */
    private IndexWriter indexWriter;

    @Override
    public boolean accept() {
        // Embedded Lucene can always start
<span class="fc" id="L98">        return true;</span>
    }

    @Override
    public void startUp() throws Exception {
        try {
<span class="fc" id="L104">            initLucene();</span>
<span class="nc" id="L105">        } catch (Exception e) {</span>
            // An error occurred initializing Lucene, the index is out of date or broken, delete everything
<span class="nc" id="L107">            log.info(&quot;Unable to initialize Lucene, cleaning up the index: &quot; + e.getMessage());</span>
<span class="nc" id="L108">            Path luceneDirectory = DirectoryUtil.getLuceneDirectory();</span>
<span class="nc" id="L109">            Files.walk(luceneDirectory)</span>
<span class="nc" id="L110">                    .sorted(Comparator.reverseOrder())</span>
<span class="nc" id="L111">                    .map(Path::toFile)</span>
<span class="nc" id="L112">                    .forEach(java.io.File::delete);</span>

            // Re-initialize and schedule a full reindex
<span class="nc" id="L115">            initLucene();</span>
<span class="nc" id="L116">            RebuildIndexAsyncEvent rebuildIndexAsyncEvent = new RebuildIndexAsyncEvent();</span>
<span class="nc" id="L117">            AppContext.getInstance().getAsyncEventBus().post(rebuildIndexAsyncEvent);</span>
<span class="fc" id="L118">        }</span>
<span class="fc" id="L119">    }</span>

    private void initLucene() throws Exception {
<span class="fc" id="L122">        ConfigDao configDao = new ConfigDao();</span>
<span class="fc" id="L123">        Config luceneStorageConfig = configDao.getById(ConfigType.LUCENE_DIRECTORY_STORAGE);</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">        String luceneStorage = luceneStorageConfig == null ? null : luceneStorageConfig.getValue();</span>

        // RAM directory storage by default
<span class="pc bpc" id="L127" title="3 of 4 branches missed.">        if (luceneStorage == null || luceneStorage.equals(&quot;RAM&quot;)) {</span>
<span class="fc" id="L128">            directory = new RAMDirectory();</span>
<span class="fc" id="L129">            log.info(&quot;Using RAM Lucene storage&quot;);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        } else if (luceneStorage.equals(&quot;FILE&quot;)) {</span>
<span class="nc" id="L131">            Path luceneDirectory = DirectoryUtil.getLuceneDirectory();</span>
<span class="nc" id="L132">            log.info(&quot;Using file Lucene storage: {}&quot;, luceneDirectory);</span>
<span class="nc" id="L133">            directory = new NIOFSDirectory(luceneDirectory, NoLockFactory.INSTANCE);</span>
        }

        // Create an index writer
<span class="fc" id="L137">        IndexWriterConfig config = new IndexWriterConfig(new StandardAnalyzer());</span>
<span class="fc" id="L138">        config.setCommitOnClose(true);</span>
<span class="fc" id="L139">        config.setMergeScheduler(new ConcurrentMergeScheduler());</span>
<span class="fc" id="L140">        indexWriter = new IndexWriter(directory, config);</span>

        // Check index version and rebuild it if necessary
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (DirectoryReader.indexExists(directory)) {</span>
<span class="nc" id="L144">            log.info(&quot;Checking index health and version&quot;);</span>
<span class="nc" id="L145">            try (CheckIndex checkIndex = new CheckIndex(directory)) {</span>
<span class="nc" id="L146">                CheckIndex.Status status = checkIndex.checkIndex();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                if (!status.clean) {</span>
<span class="nc" id="L148">                    throw new Exception(&quot;Index is dirty&quot;);</span>
                }
            }
        }
<span class="fc" id="L152">    }</span>

    @Override
    public void shutDown() {
<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (directoryReader != null) {</span>
            try {
<span class="nc" id="L158">                directoryReader.close();</span>
<span class="nc" id="L159">            } catch (IOException e) {</span>
<span class="nc" id="L160">                log.error(&quot;Error closing the index reader&quot;, e);</span>
<span class="nc" id="L161">            }</span>
        }
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (indexWriter != null) {</span>
            try {
<span class="nc" id="L165">                indexWriter.close();</span>
<span class="nc" id="L166">            } catch (IOException e) {</span>
<span class="nc" id="L167">                log.error(&quot;Error closing the index writer, index may be corrupt&quot;, e);</span>
<span class="nc" id="L168">            }</span>
        }
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (directory != null) {</span>
            try {
<span class="nc" id="L172">                directory.close();</span>
<span class="nc" id="L173">            } catch (IOException e) {</span>
<span class="nc" id="L174">                log.error(&quot;Error closing Lucene index&quot;, e);</span>
<span class="nc" id="L175">            }</span>
        }
<span class="nc" id="L177">    }</span>

    @Override
    public void clearIndex() {
<span class="nc" id="L181">        handle(IndexWriter::deleteAll);</span>
<span class="nc" id="L182">    }</span>

    @Override
    public void createDocuments(List&lt;Document&gt; documentList) {
<span class="nc" id="L186">        handle(indexWriter -&gt; {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            for (Document document : documentList) {</span>
<span class="nc" id="L188">                org.apache.lucene.document.Document luceneDocument = getDocumentFromDocument(document);</span>
<span class="nc" id="L189">                indexWriter.addDocument(luceneDocument);</span>
<span class="nc" id="L190">            }</span>
<span class="nc" id="L191">        });</span>
<span class="nc" id="L192">    }</span>

    @Override
    public void createFiles(List&lt;File&gt; fileList) {
<span class="nc" id="L196">        handle(indexWriter -&gt; {</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">            for (File file : fileList) {</span>
<span class="nc" id="L198">                org.apache.lucene.document.Document luceneDocument = getDocumentFromFile(file);</span>
<span class="nc" id="L199">                indexWriter.addDocument(luceneDocument);</span>
<span class="nc" id="L200">            }</span>
<span class="nc" id="L201">        });</span>
<span class="nc" id="L202">    }</span>

    @Override
    public void createDocument(final Document document) {
<span class="nc" id="L206">        handle(indexWriter -&gt; {</span>
<span class="nc" id="L207">            org.apache.lucene.document.Document luceneDocument = getDocumentFromDocument(document);</span>
<span class="nc" id="L208">            indexWriter.addDocument(luceneDocument);</span>
<span class="nc" id="L209">        });</span>
<span class="nc" id="L210">    }</span>

    @Override
    public void createFile(final File file) {
<span class="nc" id="L214">        handle(indexWriter -&gt; {</span>
<span class="nc" id="L215">            org.apache.lucene.document.Document luceneDocument = getDocumentFromFile(file);</span>
<span class="nc" id="L216">            indexWriter.addDocument(luceneDocument);</span>
<span class="nc" id="L217">        });</span>
<span class="nc" id="L218">    }</span>

    @Override
    public void updateFile(final File file) {
<span class="nc" id="L222">        handle(indexWriter -&gt; {</span>
<span class="nc" id="L223">            org.apache.lucene.document.Document luceneDocument = getDocumentFromFile(file);</span>
<span class="nc" id="L224">            indexWriter.updateDocument(new Term(&quot;id&quot;, file.getId()), luceneDocument);</span>
<span class="nc" id="L225">        });</span>
<span class="nc" id="L226">    }</span>

    @Override
    public void updateDocument(final Document document) {
<span class="nc" id="L230">        handle(indexWriter -&gt; {</span>
<span class="nc" id="L231">            org.apache.lucene.document.Document luceneDocument = getDocumentFromDocument(document);</span>
<span class="nc" id="L232">            indexWriter.updateDocument(new Term(&quot;id&quot;, document.getId()), luceneDocument);</span>
<span class="nc" id="L233">        });</span>
<span class="nc" id="L234">    }</span>

    @Override
    public void deleteDocument(final String id) {
<span class="nc" id="L238">        handle(indexWriter -&gt; indexWriter.deleteDocuments(new Term(&quot;id&quot;, id)));</span>
<span class="nc" id="L239">    }</span>

    @Override
    public void createAcl(String sourceId, PermType perm, String targetId) {
        // Lucene does not index ACLs
<span class="nc" id="L244">    }</span>

    @Override
    public void deleteAcl(String sourceId, PermType perm, String targetId) {
        // Lucene does not index ACLs
<span class="nc" id="L249">    }</span>

    @Override
    public void findByCriteria(PaginatedList&lt;DocumentDto&gt; paginatedList, List&lt;String&gt; suggestionList, DocumentCriteria criteria, SortCriteria sortCriteria) throws Exception {
<span class="nc" id="L253">        Map&lt;String, Object&gt; parameterMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L254">        List&lt;String&gt; criteriaList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L255">        Map&lt;String, String&gt; documentSearchMap = Maps.newHashMap();</span>

<span class="nc" id="L257">        StringBuilder sb = new StringBuilder(&quot;select distinct d.DOC_ID_C c0, d.DOC_TITLE_C c1, d.DOC_DESCRIPTION_C c2, d.DOC_CREATEDATE_D c3, d.DOC_LANGUAGE_C c4, d.DOC_IDFILE_C, &quot;);</span>
<span class="nc" id="L258">        sb.append(&quot; s.count c5, &quot;);</span>
<span class="nc" id="L259">        sb.append(&quot; rs2.RTP_ID_C c7, rs2.RTP_NAME_C, d.DOC_UPDATEDATE_D c8 &quot;);</span>
<span class="nc" id="L260">        sb.append(&quot; from T_DOCUMENT d &quot;);</span>
<span class="nc" id="L261">        sb.append(&quot; left join (SELECT count(s.SHA_ID_C) count, ac.ACL_SOURCEID_C &quot; +</span>
                &quot;   FROM T_SHARE s, T_ACL ac &quot; +
                &quot;   WHERE ac.ACL_TARGETID_C = s.SHA_ID_C AND ac.ACL_DELETEDATE_D IS NULL AND &quot; +
                &quot;         s.SHA_DELETEDATE_D IS NULL group by ac.ACL_SOURCEID_C) s on s.ACL_SOURCEID_C = d.DOC_ID_C &quot;);
<span class="nc" id="L265">        sb.append(&quot; left join (select rs.*, rs3.idDocument &quot; +</span>
                &quot;from T_ROUTE_STEP rs &quot; +
                &quot;join (select r.RTE_IDDOCUMENT_C idDocument, rs.RTP_IDROUTE_C idRoute, min(rs.RTP_ORDER_N) minOrder from T_ROUTE_STEP rs join T_ROUTE r on r.RTE_ID_C = rs.RTP_IDROUTE_C and r.RTE_DELETEDATE_D is null where rs.RTP_DELETEDATE_D is null and rs.RTP_ENDDATE_D is null group by rs.RTP_IDROUTE_C, r.RTE_IDDOCUMENT_C) rs3 on rs.RTP_IDROUTE_C = rs3.idRoute and rs.RTP_ORDER_N = rs3.minOrder &quot; +
                &quot;where rs.RTP_IDTARGET_C in (:targetIdList)) rs2 on rs2.idDocument = d.DOC_ID_C &quot;);

        // Add search criterias
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (!SecurityUtil.skipAclCheck(criteria.getTargetIdList())) {</span>
            // Read permission is enough for searching
<span class="nc" id="L273">            sb.append(&quot; left join T_ACL a on a.ACL_TARGETID_C in (:targetIdList) and a.ACL_SOURCEID_C = d.DOC_ID_C and a.ACL_PERM_C = 'READ' and a.ACL_DELETEDATE_D is null &quot;);</span>
<span class="nc" id="L274">            sb.append(&quot; left join T_DOCUMENT_TAG dta on dta.DOT_IDDOCUMENT_C = d.DOC_ID_C and dta.DOT_DELETEDATE_D is null &quot;);</span>
<span class="nc" id="L275">            sb.append(&quot; left join T_ACL a2 on a2.ACL_TARGETID_C in (:targetIdList) and a2.ACL_SOURCEID_C = dta.DOT_IDTAG_C and a2.ACL_PERM_C = 'READ' and a2.ACL_DELETEDATE_D is null &quot;);</span>
<span class="nc" id="L276">            criteriaList.add(&quot;(a.ACL_ID_C is not null or a2.ACL_ID_C is not null)&quot;);</span>
        }
<span class="nc" id="L278">        parameterMap.put(&quot;targetIdList&quot;, criteria.getTargetIdList());</span>
<span class="nc bnc" id="L279" title="All 4 branches missed.">        if (!Strings.isNullOrEmpty(criteria.getSimpleSearch()) || !Strings.isNullOrEmpty(criteria.getFullSearch())) {</span>
<span class="nc" id="L280">            documentSearchMap = search(criteria.getSimpleSearch(), criteria.getFullSearch());</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">            if (documentSearchMap.isEmpty()) {</span>
                // If the search doesn't find any document, the request should return nothing
<span class="nc" id="L283">                documentSearchMap.put(UUID.randomUUID().toString(), null);</span>
            }
<span class="nc" id="L285">            criteriaList.add(&quot;d.DOC_ID_C in :documentIdList&quot;);</span>
<span class="nc" id="L286">            parameterMap.put(&quot;documentIdList&quot;, documentSearchMap.keySet());</span>

<span class="nc" id="L288">            suggestSearchTerms(criteria.getFullSearch(), suggestionList);</span>
        }
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (criteria.getCreateDateMin() != null) {</span>
<span class="nc" id="L291">            criteriaList.add(&quot;d.DOC_CREATEDATE_D &gt;= :createDateMin&quot;);</span>
<span class="nc" id="L292">            parameterMap.put(&quot;createDateMin&quot;, criteria.getCreateDateMin());</span>
        }
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (criteria.getCreateDateMax() != null) {</span>
<span class="nc" id="L295">            criteriaList.add(&quot;d.DOC_CREATEDATE_D &lt;= :createDateMax&quot;);</span>
<span class="nc" id="L296">            parameterMap.put(&quot;createDateMax&quot;, criteria.getCreateDateMax());</span>
        }
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (criteria.getUpdateDateMin() != null) {</span>
<span class="nc" id="L299">            criteriaList.add(&quot;d.DOC_UPDATEDATE_D &gt;= :updateDateMin&quot;);</span>
<span class="nc" id="L300">            parameterMap.put(&quot;updateDateMin&quot;, criteria.getUpdateDateMin());</span>
        }
<span class="nc bnc" id="L302" title="All 2 branches missed.">        if (criteria.getUpdateDateMax() != null) {</span>
<span class="nc" id="L303">            criteriaList.add(&quot;d.DOC_UPDATEDATE_D &lt;= :updateDateMax&quot;);</span>
<span class="nc" id="L304">            parameterMap.put(&quot;updateDateMax&quot;, criteria.getUpdateDateMax());</span>
        }
<span class="nc bnc" id="L306" title="All 2 branches missed.">        if (!criteria.getTitleList().isEmpty()) {</span>
<span class="nc" id="L307">            criteriaList.add(&quot;d.DOC_TITLE_C in :title&quot;);</span>
<span class="nc" id="L308">            parameterMap.put(&quot;title&quot;, criteria.getTitleList());</span>
        }
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (!criteria.getTagIdList().isEmpty()) {</span>
<span class="nc" id="L311">            int index = 0;</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            for (List&lt;String&gt; tagIdList : criteria.getTagIdList()) {</span>
<span class="nc" id="L313">                List&lt;String&gt; tagCriteriaList = Lists.newArrayList();</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">                for (String tagId : tagIdList) {</span>
<span class="nc" id="L315">                    sb.append(String.format(&quot;left join T_DOCUMENT_TAG dt%d on dt%d.DOT_IDDOCUMENT_C = d.DOC_ID_C and dt%d.DOT_IDTAG_C = :tagId%d and dt%d.DOT_DELETEDATE_D is null &quot;, index, index, index, index, index));</span>
<span class="nc" id="L316">                    parameterMap.put(&quot;tagId&quot; + index, tagId);</span>
<span class="nc" id="L317">                    tagCriteriaList.add(String.format(&quot;dt%d.DOT_ID_C is not null&quot;, index));</span>
<span class="nc" id="L318">                    index++;</span>
<span class="nc" id="L319">                }</span>
<span class="nc" id="L320">                criteriaList.add(&quot;(&quot; + Joiner.on(&quot; OR &quot;).join(tagCriteriaList) + &quot;)&quot;);</span>
<span class="nc" id="L321">            }</span>
        }
<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (!criteria.getExcludedTagIdList().isEmpty()) {</span>
<span class="nc" id="L324">            int index = 0;</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">            for (List&lt;String&gt; tagIdList : criteria.getExcludedTagIdList()) {</span>
<span class="nc" id="L326">                List&lt;String&gt; tagCriteriaList = Lists.newArrayList();</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                for (String tagId : tagIdList) {</span>
<span class="nc" id="L328">                    sb.append(String.format(&quot;left join T_DOCUMENT_TAG dtex%d on dtex%d.DOT_IDDOCUMENT_C = d.DOC_ID_C and dtex%d.DOT_IDTAG_C = :tagIdEx%d and dtex%d.DOT_DELETEDATE_D is null &quot;, index, index, index, index, index));</span>
<span class="nc" id="L329">                    parameterMap.put(&quot;tagIdEx&quot; + index, tagId);</span>
<span class="nc" id="L330">                    tagCriteriaList.add(String.format(&quot;dtex%d.DOT_ID_C is null&quot;, index));</span>
<span class="nc" id="L331">                    index++;</span>
<span class="nc" id="L332">                }</span>
<span class="nc" id="L333">                criteriaList.add(&quot;(&quot; + Joiner.on(&quot; AND &quot;).join(tagCriteriaList) + &quot;)&quot;);</span>
<span class="nc" id="L334">            }</span>
        }
<span class="nc bnc" id="L336" title="All 4 branches missed.">        if (criteria.getShared() != null &amp;&amp; criteria.getShared()) {</span>
<span class="nc" id="L337">            criteriaList.add(&quot;s.count &gt; 0&quot;);</span>
        }
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (criteria.getMimeType() != null) {</span>
<span class="nc" id="L340">            sb.append(&quot;left join T_FILE f0 on f0.FIL_IDDOC_C = d.DOC_ID_C and f0.FIL_MIMETYPE_C = :mimeType and f0.FIL_DELETEDATE_D is null&quot;);</span>
<span class="nc" id="L341">            parameterMap.put(&quot;mimeType&quot;, criteria.getMimeType());</span>
<span class="nc" id="L342">            criteriaList.add(&quot;f0.FIL_ID_C is not null&quot;);</span>
        }
<span class="nc bnc" id="L344" title="All 2 branches missed.">        if (criteria.getLanguage() != null) {</span>
<span class="nc" id="L345">            criteriaList.add(&quot;d.DOC_LANGUAGE_C = :language&quot;);</span>
<span class="nc" id="L346">            parameterMap.put(&quot;language&quot;, criteria.getLanguage());</span>
        }
<span class="nc bnc" id="L348" title="All 2 branches missed.">        if (criteria.getCreatorId() != null) {</span>
<span class="nc" id="L349">            criteriaList.add(&quot;d.DOC_IDUSER_C = :creatorId&quot;);</span>
<span class="nc" id="L350">            parameterMap.put(&quot;creatorId&quot;, criteria.getCreatorId());</span>
        }
<span class="nc bnc" id="L352" title="All 4 branches missed.">        if (criteria.getActiveRoute() != null &amp;&amp; criteria.getActiveRoute()) {</span>
<span class="nc" id="L353">            criteriaList.add(&quot;rs2.RTP_ID_C is not null&quot;);</span>
        }

<span class="nc" id="L356">        criteriaList.add(&quot;d.DOC_DELETEDATE_D is null&quot;);</span>

<span class="nc" id="L358">        sb.append(&quot; where &quot;);</span>
<span class="nc" id="L359">        sb.append(Joiner.on(&quot; and &quot;).join(criteriaList));</span>

        // Perform the search
<span class="nc" id="L362">        QueryParam queryParam = new QueryParam(sb.toString(), parameterMap);</span>
<span class="nc" id="L363">        List&lt;Object[]&gt; l = PaginatedLists.executePaginatedQuery(paginatedList, queryParam, sortCriteria);</span>

        // Assemble results
<span class="nc" id="L366">        List&lt;DocumentDto&gt; documentDtoList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        for (Object[] o : l) {</span>
<span class="nc" id="L368">            int i = 0;</span>
<span class="nc" id="L369">            DocumentDto documentDto = new DocumentDto();</span>
<span class="nc" id="L370">            documentDto.setId((String) o[i++]);</span>
<span class="nc" id="L371">            documentDto.setTitle((String) o[i++]);</span>
<span class="nc" id="L372">            documentDto.setDescription((String) o[i++]);</span>
<span class="nc" id="L373">            documentDto.setCreateTimestamp(((Timestamp) o[i++]).getTime());</span>
<span class="nc" id="L374">            documentDto.setLanguage((String) o[i++]);</span>
<span class="nc" id="L375">            documentDto.setFileId((String) o[i++]);</span>
<span class="nc" id="L376">            Number shareCount = (Number) o[i++];</span>
<span class="nc bnc" id="L377" title="All 4 branches missed.">            documentDto.setShared(shareCount != null &amp;&amp; shareCount.intValue() &gt; 0);</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">            documentDto.setActiveRoute(o[i++] != null);</span>
<span class="nc" id="L379">            documentDto.setCurrentStepName((String) o[i++]);</span>
<span class="nc" id="L380">            documentDto.setUpdateTimestamp(((Timestamp) o[i]).getTime());</span>
<span class="nc" id="L381">            documentDto.setHighlight(documentSearchMap.get(documentDto.getId()));</span>
<span class="nc" id="L382">            documentDtoList.add(documentDto);</span>
<span class="nc" id="L383">        }</span>

<span class="nc" id="L385">        paginatedList.setResultList(documentDtoList);</span>
<span class="nc" id="L386">    }</span>

    /**
     * Suggest search terms according to the user query.
     *
     * @param search User search query
     * @param suggestionList Suggestion of search query (updated by side effects)
     * @throws Exception e
     */
    private void suggestSearchTerms(String search, List&lt;String&gt; suggestionList) throws Exception {
<span class="nc" id="L396">        DirectoryReader directoryReader = getDirectoryReader();</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">        if (directoryReader == null) {</span>
<span class="nc" id="L398">            return;</span>
        }

<span class="nc" id="L401">        FuzzySuggester suggester = new FuzzySuggester(directory, &quot;&quot;, new StandardAnalyzer());</span>
<span class="nc" id="L402">        LuceneDictionary dictionary = new LuceneDictionary(directoryReader, &quot;title&quot;);</span>
<span class="nc" id="L403">        suggester.build(dictionary);</span>
<span class="nc" id="L404">        int lastIndex = search.lastIndexOf(' ');</span>
<span class="nc" id="L405">        String suggestQuery = search.substring(Math.max(lastIndex, 0));</span>
<span class="nc" id="L406">        List&lt;Lookup.LookupResult&gt; lookupResultList = suggester.lookup(suggestQuery, false, 10);</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">        for (Lookup.LookupResult lookupResult : lookupResultList) {</span>
<span class="nc" id="L408">            suggestionList.add(lookupResult.key.toString());</span>
<span class="nc" id="L409">        }</span>
<span class="nc" id="L410">    }</span>

    /**
     * Fulltext search in files and documents.
     *
     * @param simpleSearchQuery Search query on metadatas
     * @param fullSearchQuery Search query on all fields
     * @return Map of document IDs as key and highlight as value
     * @throws Exception e
     */
    private Map&lt;String, String&gt; search(String simpleSearchQuery, String fullSearchQuery) throws Exception {
        // The fulltext query searches in all fields
<span class="nc" id="L422">        String searchQuery = simpleSearchQuery + &quot; &quot; + fullSearchQuery;</span>

        // Build search query
<span class="nc" id="L425">        Analyzer analyzer = new StandardAnalyzer();</span>

        // Search on documents and files
<span class="nc" id="L428">        BooleanQuery query = new BooleanQuery.Builder()</span>
<span class="nc" id="L429">                .add(buildQueryParser(analyzer, &quot;title&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L430">                .add(buildQueryParser(analyzer, &quot;description&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L431">                .add(buildQueryParser(analyzer, &quot;subject&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L432">                .add(buildQueryParser(analyzer, &quot;identifier&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L433">                .add(buildQueryParser(analyzer, &quot;publisher&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L434">                .add(buildQueryParser(analyzer, &quot;format&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L435">                .add(buildQueryParser(analyzer, &quot;source&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L436">                .add(buildQueryParser(analyzer, &quot;type&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L437">                .add(buildQueryParser(analyzer, &quot;coverage&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L438">                .add(buildQueryParser(analyzer, &quot;rights&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L439">                .add(buildQueryParser(analyzer, &quot;filename&quot;).parse(searchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L440">                .add(buildQueryParser(analyzer, &quot;content&quot;).parse(fullSearchQuery), BooleanClause.Occur.SHOULD)</span>
<span class="nc" id="L441">                .build();</span>

        // Search
<span class="nc" id="L444">        DirectoryReader directoryReader = getDirectoryReader();</span>
<span class="nc" id="L445">        Map&lt;String, String&gt; documentMap = Maps.newHashMap();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">        if (directoryReader == null) {</span>
            // The directory reader is not yet initialized (probably because there is nothing indexed)
<span class="nc" id="L448">            return documentMap;</span>
        }
<span class="nc" id="L450">        IndexSearcher searcher = new IndexSearcher(directoryReader);</span>
<span class="nc" id="L451">        TopDocs topDocs = searcher.search(query, Integer.MAX_VALUE);</span>
<span class="nc" id="L452">        ScoreDoc[] docs = topDocs.scoreDocs;</span>

<span class="nc" id="L454">        SimpleHTMLFormatter simpleHTMLFormatter = new SimpleHTMLFormatter(&quot;&lt;strong&gt;&quot;, &quot;&lt;/strong&gt;&quot;);</span>
<span class="nc" id="L455">        SimpleHTMLEncoder simpleHTMLEncoder = new SimpleHTMLEncoder();</span>
<span class="nc" id="L456">        Highlighter highlighter = new Highlighter(simpleHTMLFormatter, simpleHTMLEncoder, new QueryScorer(query));</span>

        // Extract document IDs and highlights
<span class="nc bnc" id="L459" title="All 2 branches missed.">        for (ScoreDoc doc : docs) {</span>
<span class="nc" id="L460">            org.apache.lucene.document.Document document = searcher.doc(doc.doc);</span>
<span class="nc" id="L461">            String type = document.get(&quot;doctype&quot;);</span>
<span class="nc" id="L462">            String documentId = null;</span>
<span class="nc" id="L463">            String highlight = null;</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">            if (type.equals(&quot;document&quot;)) {</span>
<span class="nc" id="L465">                documentId = document.get(&quot;id&quot;);</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">            } else if (type.equals(&quot;file&quot;)) {</span>
<span class="nc" id="L467">                documentId = document.get(&quot;document_id&quot;);</span>
<span class="nc" id="L468">                String content = document.get(&quot;content&quot;);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                if (content != null) {</span>
<span class="nc" id="L470">                    highlight = highlighter.getBestFragment(analyzer, &quot;content&quot;, content);</span>
                }
            }

<span class="nc bnc" id="L474" title="All 2 branches missed.">            if (documentId != null) {</span>
<span class="nc" id="L475">                documentMap.put(documentId, highlight);</span>
            }
        }

<span class="nc" id="L479">        return documentMap;</span>
    }

    /**
     * Build a query parser for searching.
     *
     * @param analyzer Analyzer
     * @param field Field
     * @return Query parser
     */
    private SimpleQueryParser buildQueryParser(Analyzer analyzer, String field) {
<span class="nc" id="L490">        SimpleQueryParser simpleQueryParser = new SimpleQueryParser(analyzer, field);</span>
<span class="nc" id="L491">        simpleQueryParser.setDefaultOperator(BooleanClause.Occur.MUST); // AND all the terms</span>
<span class="nc" id="L492">        return simpleQueryParser;</span>
    }

    /**
     * Build Lucene document from database document.
     *
     * @param document Document
     * @return Document
     */
    private org.apache.lucene.document.Document getDocumentFromDocument(Document document) {
<span class="nc" id="L502">        org.apache.lucene.document.Document luceneDocument = new org.apache.lucene.document.Document();</span>
<span class="nc" id="L503">        luceneDocument.add(new StringField(&quot;id&quot;, document.getId(), Field.Store.YES));</span>
<span class="nc" id="L504">        luceneDocument.add(new StringField(&quot;doctype&quot;, &quot;document&quot;, Field.Store.YES));</span>
<span class="nc" id="L505">        luceneDocument.add(new TextField(&quot;title&quot;, document.getTitle(), Field.Store.NO));</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if (document.getDescription() != null) {</span>
<span class="nc" id="L507">            luceneDocument.add(new TextField(&quot;description&quot;, document.getDescription(), Field.Store.NO));</span>
        }
<span class="nc bnc" id="L509" title="All 2 branches missed.">        if (document.getSubject() != null) {</span>
<span class="nc" id="L510">            luceneDocument.add(new TextField(&quot;subject&quot;, document.getSubject(), Field.Store.NO));</span>
        }
<span class="nc bnc" id="L512" title="All 2 branches missed.">        if (document.getIdentifier() != null) {</span>
<span class="nc" id="L513">            luceneDocument.add(new TextField(&quot;identifier&quot;, document.getIdentifier(), Field.Store.NO));</span>
        }
<span class="nc bnc" id="L515" title="All 2 branches missed.">        if (document.getPublisher() != null) {</span>
<span class="nc" id="L516">            luceneDocument.add(new TextField(&quot;publisher&quot;, document.getPublisher(), Field.Store.NO));</span>
        }
<span class="nc bnc" id="L518" title="All 2 branches missed.">        if (document.getFormat() != null) {</span>
<span class="nc" id="L519">            luceneDocument.add(new TextField(&quot;format&quot;, document.getFormat(), Field.Store.NO));</span>
        }
<span class="nc bnc" id="L521" title="All 2 branches missed.">        if (document.getSource() != null) {</span>
<span class="nc" id="L522">            luceneDocument.add(new TextField(&quot;source&quot;, document.getSource(), Field.Store.NO));</span>
        }
<span class="nc bnc" id="L524" title="All 2 branches missed.">        if (document.getType() != null) {</span>
<span class="nc" id="L525">            luceneDocument.add(new TextField(&quot;type&quot;, document.getType(), Field.Store.NO));</span>
        }
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (document.getCoverage() != null) {</span>
<span class="nc" id="L528">            luceneDocument.add(new TextField(&quot;coverage&quot;, document.getCoverage(), Field.Store.NO));</span>
        }
<span class="nc bnc" id="L530" title="All 2 branches missed.">        if (document.getRights() != null) {</span>
<span class="nc" id="L531">            luceneDocument.add(new TextField(&quot;rights&quot;, document.getRights(), Field.Store.NO));</span>
        }

<span class="nc" id="L534">        return luceneDocument;</span>
    }

    /**
     * Build Lucene document from file.
     *
     * @param file File
     * @return Document
     */
    private org.apache.lucene.document.Document getDocumentFromFile(File file) {
<span class="nc" id="L544">        org.apache.lucene.document.Document luceneDocument = new org.apache.lucene.document.Document();</span>
<span class="nc" id="L545">        luceneDocument.add(new StringField(&quot;id&quot;, file.getId(), Field.Store.YES));</span>
<span class="nc" id="L546">        luceneDocument.add(new StringField(&quot;doctype&quot;, &quot;file&quot;, Field.Store.YES));</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">        if (file.getName() != null) {</span>
<span class="nc" id="L548">            luceneDocument.add(new TextField(&quot;filename&quot;, file.getName(), Field.Store.NO));</span>
        }
<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (file.getDocumentId() != null) {</span>
<span class="nc" id="L551">            luceneDocument.add(new StringField(&quot;document_id&quot;, file.getDocumentId(), Field.Store.YES));</span>
        }
<span class="nc bnc" id="L553" title="All 2 branches missed.">        if (file.getContent() != null) {</span>
<span class="nc" id="L554">            luceneDocument.add(new TextField(&quot;content&quot;, file.getContent(), Field.Store.YES));</span>
        }

<span class="nc" id="L557">        return luceneDocument;</span>
    }

    /**
     * Returns a valid directory reader.
     * Take care of reopening the reader if the index has changed
     * and closing the previous one.
     *
     * @return the directoryReader
     */
    private DirectoryReader getDirectoryReader() {
<span class="nc bnc" id="L568" title="All 2 branches missed.">        if (directoryReader == null) {</span>
            try {
<span class="nc bnc" id="L570" title="All 2 branches missed.">                if (!DirectoryReader.indexExists(directory)) {</span>
<span class="nc" id="L571">                    return null;</span>
                }
<span class="nc" id="L573">                directoryReader = DirectoryReader.open(directory);</span>
<span class="nc" id="L574">            } catch (IOException e) {</span>
<span class="nc" id="L575">                log.error(&quot;Error creating the directory reader&quot;, e);</span>
<span class="nc" id="L576">            }</span>
        } else {
            try {
<span class="nc" id="L579">                DirectoryReader newReader = DirectoryReader.openIfChanged(directoryReader);</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">                if (newReader != null) {</span>
<span class="nc" id="L581">                    directoryReader.close();</span>
<span class="nc" id="L582">                    directoryReader = newReader;</span>
                }
<span class="nc" id="L584">            } catch (IOException e) {</span>
<span class="nc" id="L585">                log.error(&quot;Error while reopening the directory reader&quot;, e);</span>
<span class="nc" id="L586">            }</span>
        }
<span class="nc" id="L588">        return directoryReader;</span>
    }

    /**
     * Encapsulate a process into a Lucene context.
     *
     * @param runnable Runnable
     */
    private void handle(LuceneRunnable runnable) {
        try {
<span class="nc" id="L598">            runnable.run(indexWriter);</span>
<span class="nc" id="L599">        } catch (Exception e) {</span>
<span class="nc" id="L600">            log.error(&quot;Error in running index writing&quot;, e);</span>
<span class="nc" id="L601">        }</span>

        try {
<span class="nc" id="L604">            indexWriter.commit();</span>
<span class="nc" id="L605">        } catch (IOException e) {</span>
<span class="nc" id="L606">            log.error(&quot;Cannot commit index writer&quot;, e);</span>
<span class="nc" id="L607">        }</span>
<span class="nc" id="L608">    }</span>

    /**
     * Lucene runnable.
     *
     * @author bgamard
     */
    private interface LuceneRunnable {
        /**
         * Code to run in a Lucene context.
         *
         * @param indexWriter Index writer
         * @throws Exception e
         */
        void run(IndexWriter indexWriter) throws Exception;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>